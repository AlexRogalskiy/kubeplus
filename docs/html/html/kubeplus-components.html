

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KubePlus Components &#8212; KubePlus 1.0.0 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/bizstyle.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Kubernetes Operators" href="operators.html" />
    <link rel="prev" title="Welcome to KubePlus documentation" href="index.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="operators.html" title="Kubernetes Operators"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="index.html" title="Welcome to KubePlus documentation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">KubePlus 1.0.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">KubePlus Components</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="kubeplus-components">
<h1>KubePlus Components</h1>
<p>KubePlus consists of - CRD for CRDs, CRD annotations, and kubectl plugins.</p>
<div class="section" id="crd-for-crds-to-design-your-platform-services-from-helm-charts">
<h2>CRD for CRDs to design your platform services from Helm charts</h2>
<p>KubePlus offers a CRD named ResourceComposition to
- Compose new CRDs (Custom Resource Definition) to publish platform services from Helm charts
- Define policies (e.g. Node selection, CPU/Memory limits, etc.) for managing resources of the platform services
- Get aggregated CPU/Memory/Storage Prometheus metrics for the platform services
Here is the high-level structure of ResourceComposition CRD:</p>
<a class="reference internal image-reference" href="_images/crd-for-crds49.png"><img alt="_images/crd-for-crds49.png" class="align-center" src="_images/crd-for-crds49.png" style="width: 550px; height: 250px;" /></a>
<p>To understand this further let us see how a platform team can build a MySQL service for their product team/s to consume. The base Kubernetes cluster has MySQL Operator on it (either installed by the Platform team or bundled by the Kubernetes provider).</p>
<a class="reference internal image-reference" href="_images/mysql-as-a-service49.png"><img alt="_images/mysql-as-a-service49.png" class="align-center" src="_images/mysql-as-a-service49.png" style="width: 400px; height: 250px;" /></a>
<p>The platform workflow requirements are:
- Create a PersistentVolume of required type for MySQL instance.
- Create Secret objects for MySQL instance and AWS backup.
- Setup a policy in such a way that Pods created under this service will have specified Resource Request and Limits.
- Get aggregated CPU/Memory metrics for the overall workflow.</p>
<p>Here is a new platform service named MysqlService as Kubernetes API.</p>
<a class="reference internal image-reference" href="_images/mysql-as-a-service-crd49.png"><img alt="_images/mysql-as-a-service-crd49.png" class="align-center" src="_images/mysql-as-a-service-crd49.png" style="width: 550px; height: 250px;" /></a>
<p>A new CRD named MysqlService has been created here using ResourceComposition. You provide a platform workflow Helm chart that creates required underlying resources, and additionally provide policy and monitoring inputs for the workflow. The Spec Properties of MysqlService come from values.yaml of the Helm chart. Product teams can use this service to get MySQL database for their application and all the required setups will be performed transparently by this service.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>apiVersion: workflows.kubeplus/v1alpha1
kind: ResourceComposition
metadata:
  name: mysqlservicetenant
spec:
  <span class="c1"># newResource defines the new CRD to be installed define a workflow.</span>
  newResource:
    resource:
      kind: MysqlServiceTenant
      group: platformapi.kubeplus
      version: v1alpha1
      plural: mysqlservicetenants
    <span class="c1"># URL of the Helm chart that contains Kubernetes resources that represent a workflow.</span>
    chartURL: https://github.com/cloud-ark/operatorcharts/blob/master/mysqlcluster-stack-0.0.1.tgz?raw<span class="o">=</span><span class="nb">true</span>
    chartName: mysqlcluster-stack
  <span class="c1"># respolicy defines the resource policy to be applied to instances of the specified custom resource.</span>
  respolicy:
    apiVersion: workflows.kubeplus/v1alpha1
    kind: ResourcePolicy
    metadata:
      name: mysqlservicetenant-policy
    spec:
      resource:
        kind: MysqlServiceTenant
        group: platformapi.kubeplus
        version: v1alpha1
      policy:
        <span class="c1"># Add following requests and limits for the first container of all the  Pods that are related via</span>
        <span class="c1"># owner reference relationship to instances of resources specified above.</span>
        podconfig:
          limits:
            cpu: 200m
            memory: 4Gi
          requests:
            cpu: 100m
            memory: 2Gi
          nodeSelector: values.nodeName
  <span class="c1"># resmonitor identifies the resource instances that should be monitored for CPU/Memory/Storage.</span>
  <span class="c1"># All the Pods that are related to the resource instance through either ownerReference relationship, or all the relationships</span>
  <span class="c1"># (ownerReference, label, annotation, spec properties) are considered in calculating the statistics.</span>
  <span class="c1"># The generated output is in Prometheus format.</span>
  resmonitor:
    apiVersion: workflows.kubeplus/v1alpha1
    kind: ResourceMonitor
    metadata:
      name: mysqlservicetenant-monitor
    spec:
      resource:
        kind: MysqlServiceTenant
        group: platformapi.kubeplus
        version: v1alpha1
      <span class="c1"># This attribute indicates that Pods that are reachable through all the   relationships should be used</span>
      <span class="c1"># as part of calculating the monitoring statistics.</span>
      monitorRelationships: all
</pre></div>
</div>
</div>
<div class="section" id="kubectl-plugins">
<h2>Kubectl plugins</h2>
<p>KubePlus offers following kubectl plugins towards discovery and use of Custom Resources and obtaining insights into Kubernetes-native application.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl man cr
$ kubectl connections
$ kubectl metrics cr
$ kubectl metrics service
$ kubectl metrics account
$ kubectl metrics helmrelease
$ kubectl grouplogs cr
$ kubectl grouplogs service
$ kubectl grouplogs helmrelease
</pre></div>
</div>
<p>In order to use these plugins you need to add KubePlus folder to your PATH variable.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">KUBEPLUS_HOME</span><span class="o">=</span>&lt;Full path where kubeplus is cloned&gt;
$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/plugins
</pre></div>
</div>
</div>
<div class="section" id="crd-annotations">
<h2>CRD annotations</h2>
<p>In order to build and maintain Custom Resource relationship graphs, KubePlus depends on following annotations to be defined on the CRD manifests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>resource/usage
</pre></div>
</div>
<p>The ‘usage’ annotation is used to define usage information for a Custom Resource.
The value of ‘usage’ annotation is the name of the ConfigMap that stores the usage information.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>resource/composition
</pre></div>
</div>
<p>The ‘composition’ annotation is used to define Kubernetes’s built-in resources that are created as part of instantiating a Custom Resource instance.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>resource/annotation-relationship
resource/label-relationship
resource/specproperty-relationship
</pre></div>
</div>
<p>The relationship annotations are used to declare annotation / label / spec-property based relationships that instances of this Custom Resource can have with other Resources.</p>
<p>Above annotations need to be defined on the Custom Resource Definition (CRD) YAMLs of Operators in order to make Custom Resources discoverable and usable by DevOps/Platform engineers.</p>
<p>As an example, annotations on Moodle Custom Resource Definition (CRD) are shown below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apiextensions.k8s.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CustomResourceDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">moodles.moodlecontroller.kubeplus</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">resource/composition</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment, Service, PersistentVolume, PersistentVolumeClaim, Secret, Ingress</span>
    <span class="nt">resource/usage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">moodle-operator-usage.usage</span>
    <span class="nt">resource/specproperty-relationship</span><span class="p">:</span> <span class="s">&quot;on:INSTANCE.spec.mySQLServiceName,</span><span class="nv"> </span><span class="s">value:Service.spec.metadata.name&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">moodlecontroller.kubeplus</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
  <span class="nt">names</span><span class="p">:</span>
    <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Moodle</span>
    <span class="nt">plural</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">moodles</span>
  <span class="nt">scope</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Namespaced</span>
</pre></div>
</div>
<p>The composition annotation declares the set of Kubernetes resources that are created by the Moodle Operator when instantiating a Moodle Custom Resource instance.
The specproperty relationship defines that an instance of Moodle Custom Resource is connected through it’s mySQLServiceName spec attribute to an instance of a Service resource through that resource’s name (metadata.name). Below is an example of a Kubernetes platform workflow in which a Moodle Custom Resource instance is bound to a MysqlCluster Custom Resource instance through the Service resource that is created by the MysqlCluster Operator. The specproperty relationship helps discover this relationship as seen below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>venv<span class="o">)</span> Devs-MacBook:kubeplus devdatta$ kubectl connections Moodle moodle1 namespace1
Level:0 kind:Moodle name:moodle1 Owner:/
Level:1 kind:Service name:cluster1-mysql-master Owner:MysqlCluster/cluster1
Level:2 kind:Pod name:cluster1-mysql-0 Owner:MysqlCluster/cluster1
Level:3 kind:Service name:cluster1-mysql-nodes Owner:MysqlCluster/cluster1
Level:3 kind:Service name:cluster1-mysql Owner:MysqlCluster/cluster1
Level:2 kind:Pod name:moodle1-5847c6b69c-mtwg8 Owner:Moodle/moodle1
Level:3 kind:Service name:moodle1 Owner:Moodle/moodle1
</pre></div>
</div>
<p>Here are examples of defining the <code class="docutils literal notranslate"><span class="pre">resource/label-relationship</span></code> and <code class="docutils literal notranslate"><span class="pre">resoure/annotation</span></code> relationship.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>resource/annotation-relationship: on:Pod, key:k8s.v1.cni.cncf.io/networks, value:INSTANCE.metadata.name
</pre></div>
</div>
<p>This annotation-relationship annotation is defined on NetworkAttachmentDefinition CRD available from the Multus Operator. It defines that the relationship between a Pod and an instance of NetworkAttachmentDefinition Custom Resource instance is through the <code class="docutils literal notranslate"><span class="pre">k8s.v1.cni.cncf.io/networks</span></code> annotation. This annotation needs to be defined on a Pod and the value of the annotation is the name of a NetworkAttachmentDefinition Custom resource instance.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>resource/specproperty-relationship: <span class="s2">&quot;on:INSTANCE.spec.volumeMounts, value:Deployment.spec.containers.volumemounts.mountpath&quot;</span>
resource/label-relationship: <span class="s2">&quot;on:Deployment, value:INSTANCE.spec.selector&quot;</span>
</pre></div>
</div>
<p>Above annotations are defined on the Restic Custom Resource available from the Stash Operator. Restic Custom Resource needs two things as input. First, the mount path of the Volume that needs to be backed up. Second, the Deployment in which the Volume is mounted needs to be given some label and that label needs to be specified in the Restic Custom Resource’s selector.</p>
</div>
<div class="section" id="crd-annotations-for-community-operators">
<h2>CRD annotations for Community Operators</h2>
<p>Checkout <a class="reference external" href="https://github.com/cloud-ark/kubeplus/blob/master/Operator-annotations.md">CRD Annotations</a>.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to KubePlus documentation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="operators.html"
                        title="next chapter">Kubernetes Operators</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="operators.html" title="Kubernetes Operators"
             >next</a></li>
        <li class="right" >
          <a href="index.html" title="Welcome to KubePlus documentation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">KubePlus 1.0.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">KubePlus Components</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>